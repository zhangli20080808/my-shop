import React from 'react';
// import common from '../../../common/common';
// import Alert from '../../../common/Alert.jsx';
// import Footer from '../../../common/Footer.jsx';
import config from '../../../config/feConfig';

const companyName = config.companyName;
import './style.css'


class Register extends React.Component {

	constructor(props) {
		super(props);
		this.state = {
			selectValue: companyName === 'NZH' ? 64 : 86,
			count: 60,
			flag: true,
			getCodeFlag: true,
			originUrl: encodeURIComponent(props.originUrl) || '',
			form: {
				phone: {
					value: '',
					valid: false,
					error: ''
				},
				picCode: {
					value: '',
					valid: false,
					error: ''
				},
				code: {
					value: '',
					valid: false,
					error: ''
				},
				fullName: {
					value: '',
					valid: false,
					error: ''
				},
				password: {
					value: '',
					valid: false,
					error: ''
				},
				againPassword: {
					value: '',
					valid: false,
					error: ''
				},
			},
		}
	}

	componentDidMount() {
		// this.getPicCode();
	}


	/**
	 * 数据校验
	 */
	// handleValueChange = (field, value) => {

	// 	let {
	// 			form,
	// 			form: {
	// 				password
	// 			},
	// 			selectValue
	// 		} = this.state,
	// 		newFieldObj = {
	// 			value,
	// 			error: '',
	// 			valid: false
	// 		};

	// 	switch (field) {
	// 		case 'phone':
	// 			if (!value) {
	// 				newFieldObj.error = '请输入手机号';
	// 				newFieldObj.valid = true;
	// 			} else {
	// 				if (!common.isValidPhone(value) && selectValue == 86) {
	// 					newFieldObj.error = '请确保手机号码无误';
	// 					newFieldObj.valid = true;
	// 				} else if (value.substr(0, 2) !== '02' && selectValue == 64) {
	// 					newFieldObj.error = '请输入以02开头的完整号码';
	// 					newFieldObj.valid = true;
	// 				} else if (value.substr(0, 2) !== '04' && selectValue == 61) {
	// 					newFieldObj.error = '请输入以04开头的完整号码';
	// 					newFieldObj.valid = true;
	// 				}
	// 			}
	// 			break;
	// 		case 'picCode':
	// 			if (!value) {
	// 				newFieldObj.error = '请输入图片验证码';
	// 				newFieldObj.valid = true;
	// 			}
	// 			break;
	// 		case 'code':
	// 			if (!value) {
	// 				newFieldObj.error = '请输入短信验证码';
	// 				newFieldObj.valid = true;
	// 			}
	// 			break;
	// 		case 'fullName':
	// 			if (!value) {
	// 				newFieldObj.error = '请输入昵称';
	// 				newFieldObj.valid = true;
	// 			}
	// 			break;
	// 		case 'password':
	// 			if (!value) {
	// 				newFieldObj.error = '请输入密码';
	// 				newFieldObj.valid = true;
	// 			} else if (value.length < 6) {
	// 				newFieldObj.error = '密码长度不能少于6位';
	// 				newFieldObj.valid = true;
	// 			}
	// 			break;
	// 		case 'againPassword':
	// 			if (!value || password.value !== value) {
	// 				newFieldObj.error = '两次输入的密码不匹配，请检查';
	// 				newFieldObj.valid = true;
	// 			}
	// 			break;
	// 	}

	// 	this.setState({
	// 		form: {
	// 			...form,
	// 			[field]: newFieldObj
	// 		}
	// 	})
	// };

	/**
	 * 获取图片验证码
	 */
	/*getPicCode = () => {
		this.setState({
			codePic: '/user/getCodePic?a=' + Math.random()
		})
	};*/

	getCountryValue = (value) => {
		const {form} = this.state;

		this.setState({
			selectValue: value,
			form: {
				...form,
				phone: {
					valid: false,
					value: '',
					error: ''
				}
			}
		})
	};

	showMsg = (msg) => {
		this.setState({
			msgFlag: true,
			msg: msg
		});
		setTimeout(() => {
			this.setState({
				msgFlag: false
			})
		}, 2000);
	};

	/**
	 * 发送验证码
	 */
	getCodeValue = () => {

		const {
			form: {
				phone,
				picCode
			},
			selectValue
		} = this.state;

		if (!phone.value || phone.valid || !picCode.value || picCode.valid) return;

		this.handleClick();  //倒计时

		common.sendRequest('post', {
			phone: phone.value,
			code: selectValue,
			picCode: picCode.value
		}, '/user/getCodeValue', (res) => {
			if (res.code === 0) this.showMsg('验证码已发送到您的手机，请注意查收短信');
		}, (res) => {
			this.showMsg(res);

		});
	};


	/**
	 * 获取验证码 - 倒计时
	 */
	handleClick = () => {

		let {flag, count, getCodeFlag} = this.state;

		if (flag) {
			this.interval = setInterval(() => {
				count = this.state.count - 1;
				if (count === 0) {
					this.interval && clearInterval(this.interval);
					count = 60;
					flag = true;
					getCodeFlag = true;
				} else {
					count = count;
					flag = false;
					getCodeFlag = false;
				}

				this.setState({
					count: count,
					flag: flag,
					getCodeFlag: getCodeFlag
				})
			}, 1000)
		}
	};


	/**
	 * 校验图形验证码输入是否正确
	 */
	checkPicCode = () => {

		const {
			form,
			form: {
				picCode
			}
		} = this.state;

		if (!picCode.value || picCode.valid) return;
		common.sendRequest('get', {picCode: picCode.value}, '/user/checkPicCode', (res) => {
			if (res.code !== 0) {
				this.setState({
					form: {
						...form,
						picCode: {
							valid: true,
							value: '',
							error: '图片验证码输入错误，请点击验证码图片重新获取'
						}
					}
				})
			}
		})
	};


	/**
	 * 注册
	 */
	handleRegister = () => {
		const {
			form: {
				code,
				phone,
				fullName,
				password,
				againPassword
			},
			selectValue
		} = this.state;

		if (!phone.value || phone.valid ||
			// !code.value || code.valid ||
			!fullName.value || fullName.valid ||
			!password.value || password.valid ||
			!againPassword.value || againPassword.valid) return;

		common.sendRequest('post', {
			phone: phone.value,
			fullName: fullName.value,
			rePassword: againPassword.value,
			password: password.value,
			// code: code.value,
			countryCode: selectValue
		}, '/user/handleRegister', (res) => {
            if (res.code === 0) {
                this.showMsg('注册成功！');
                window.location.href = "/user/login?ref=" + this.state.originUrl;
            }else{
                this.showMsg(res.message)
            }
		}, (res) => {
			this.showMsg(res);
		})
	};

	showMmCoupon = () => {
		this.setState({
			mmFlag: true
		})
	};

	handdleBack = () => {
		this.setState({
			confirmFlag: true
		})
	};

	cancel = () => {
		this.setState({
			confirmFlag: false
		})
	};

	confirm = () => {
		this.setState({
			confirmFlag: false,
		}, () => {
			location.href = "/";
		})
	};

	linkToVoucher = () => {
		const {
			form: {
				phone,
				password
			},
		} = this.state;

		common.sendRequest('post', {
			accountVal: phone.value,
			passwordVal: password.value
		}, '/user/handleLogin', (res) => {
			window.location.href = '/coupon';
		}, (res) => this.showMsg(res));
	};

	render = () => {
		const {
				form,
				form: {
					phone,
					picCode,
					code,
					fullName,
					password,
					againPassword
				},
				originUrl,
				selectValue,
				flag,
				count,
				msg,
				msgFlag,
				confirmFlag,
				codePic,
				mmFlag
			} = this.state
			/*{
				companyInfo
			} = this.props;*/


		return (
			<div className="register-page">
				<div className="login-sec1">
					<div className="logo inner">
						<a onClick={this.handdleBack}>
							{/*<img src={companyInfo.logo}/>*/}
						</a>
					</div>
				</div>
				<div className="login-sec2">
					<div className="inner">
						<div className="user-main">
							<div className="login register">
								<h2>用户注册</h2>
								<form>
									<div className="login-form register-style">
										<label>
											{companyName === l2Warehouse ?
												<select className="country" value={selectValue}
																onChange={(e) => this.getCountryValue(e.target.value)}>
													<option value="86">中国+86</option>
												</select> :
												companyName === 'LINKC' ?
													<select className="country" value={selectValue}
																	onChange={(e) => this.getCountryValue(e.target.value)}>
														<option value="86">中国+86</option>
														<option value="61">澳大利亚+61</option>
													</select> :
													<select className="country" value={selectValue}
																	onChange={(e) => this.getCountryValue(e.target.value)}>
														<option value="64">新西兰+64</option>
														<option value="86">中国+86</option>
														<option value="61">澳大利亚+61</option>
													</select>
											}
											<input
												className="phone-col"
												type="text"
												placeholder="手机号码是您的登录账号"
												maxLength="11"
												value={phone.value}
												onChange={(e) => this.handleValueChange('phone', e.target.value)}
											/>
											{phone.valid ? <p className="error error5">{phone.error}</p> : ''}
										</label>
										{/*{!phone.valid && phone.value ?
											<label>
												<input
													type="text"
													placeholder="图片验证码"
													onChange={(e) => this.handleValueChange('picCode', e.target.value)}
													onBlur={this.checkPicCode}
												/>
												{picCode.valid ? <p className="error error5">{picCode.error}</p> : ''}
												<span className="get-code pic-code" onClick={this.getPicCode}>
                          <img src={codePic}/>
                        </span>
											</label> : ''
										}*/}
										{/*<label>
											<input
												type="text"
												placeholder="短信验证码"
												onChange={(e) => this.handleValueChange('code', e.target.value)}
											/>
											{code.valid ? <p className="error error5">{code.error}</p> : ''}
											{flag ?
												!picCode.valid && picCode.value ?
													<a className="get-code get-code-true" onClick={this.getCodeValue}>发送验证码</a> :
													<a className="get-code get-code-false">发送验证码</a>
												:
												<a className="get-code">{count}秒后重新获取</a>
											}
										</label>*/}
										<label>
											<input
												type="text"
												placeholder="昵称（长度不超过20）"
												onChange={(e) => this.handleValueChange('fullName', e.target.value)}
											/>
											{fullName.valid ? <p className="error error5">{fullName.error}</p> : ''}
										</label>
										<label>
											<input
												type="password"
												placeholder="密码（6-16位密码，区分大小写）"
												onChange={(e) => this.handleValueChange('password', e.target.value)}
											/>
											{password.valid ? <p className="error error5">{password.error}</p> : ''}
										</label>
										<label>
											<input
												type="password"
												placeholder="确认密码"
												ref="rePassword"
												onChange={(e) => this.handleValueChange('againPassword', e.target.value)}
											/>
											{againPassword.valid ? <p className="error error5">{againPassword.error}</p> : ''}
										</label>
									</div>
									<a className="login-btn register-btn" onClick={this.handleRegister}>注册</a>
									<a className="to-login" href={"/user/login?ref=" + originUrl}>已有账号？去登录</a>
								</form>
							</div>
						</div>
					</div>
					{msgFlag ? <Alert msg={msg}/> : ''}
					{confirmFlag ?
						<div className="dialog-box">
							<div className="dialog-main" style={{width: '570px'}}>
								<h3>确认放弃注册？</h3>
								<div className="dialog-btn">
									<a className="confirm" onClick={this.confirm} style={{marginRight: '70px'}}>确定</a>
									<a className="cancel" onClick={this.cancel}>取消</a>
								</div>
							</div>
						</div> : ''
					}
					{
						mmFlag ? (
							<div className={mmFlag ? 'dialog-box animated zoomIn' : 'dialog-box'}>
								<div className="dialog-main register-coupon" onClick={this.linkToVoucher}>
									<img src="/images/mm.jpg"/>
								</div>
							</div>
						) : ''
					}
				</div>
				{/*<Footer companyInfo={companyInfo}/>*/}
				<Footer/>
			</div>
		)
	}
}

export default Register;